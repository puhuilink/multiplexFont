<template>
  <div class="wrapper">
    <!-- flex布局 -->
    <!-- 内容主体 -->
    <div class="content">
      <!-- card -->
      <div class="content_card">
        <div class="card_wrapper" v-for="item in card" :key="item.id" :style="item.style">
          <div
            class="icon"
            :style="{
              background: 'url(' + item.img +') no-repeat',
              backgroundSize: 'cover',
            }"></div>
          <div class="c_content">
            <div class="titleText">
              {{ item.title }}
            </div>
            <div class="countNum">
              <div class="value">
                {{ item.value }}
              </div>
              <div class="unit">
                {{ item.unit }}
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- card end -->

      <!-- echarts pie -->
      <div class="content_pie_wrapper">
        <div class="pie level"></div>
        <div class="pie catogray"></div>
        <div class="pie total"></div>
      </div>
      <!-- echarts pie end -->

      <!-- echarts lines -->
      <div class="content_lines_wrapper">
        <div class="lines_title">
          <div class="titleTextTwo">漏洞修复走势</div>
          <div class="lines_tips">修复率</div>
          <div class="lines_tabBar">
            <div class="item" @click="toggleData">本周</div>
            <div class="item active" @click="toggleData1">本月</div>
          </div>
        </div>
        <a-spin :spinning="loading"><div class="lines_content"></div></a-spin>

      </div>
      <!-- <div class="bottonbox"></div> -->
      <!-- end -->
      <div class="tips_lines"></div>
    </div>
    <div class="bottonBar">
      <!-- <Tabbar /> -->
    </div>
  </div>
</template>

<script>
// import Tabbar from '@/components/Tabbar.vue';
import {
  card,
  level_option,
  catogray_option,
  total_option,
  lines_option_month,
  getPatchStat,
  getHistory,
  getTypeCount,
  getAgentNum
} from './api.js'
import * as echarts from 'echarts'
import Timeout from 'await-timeout'

export default {
  name: 'VulnerabilityMonitoring',
  data () {
    return {
      card,
      total_option,
      lines_option_month,
      level_option,
      catogray_option,
      dataArrayWeek: null,
      dataArrayMonth: null,
      loading: false
    }
  },
  // components: {
  //   Tabbar,
  // },
  watch: {
    // total_option: {
    //   handler () {
    //     this.$nextTick(() => {
    //       this.initCharts('.total', this.total_option)
    //     })
    //   },
    //   deep: true,
    //   immediate: true
    // },
    // 'lines_option_month.xAxis.data': {
    //   handler () {
    //     this.$nextTick(() => {
    //       this.initCharts('.lines_content', this.lines_option_month)
    //     })
    //   },
    //   deep: true
    // }
  },

  mounted () {
    this.getPageData()
    // 获取安全狗-月漏洞修复走势
    this.getMR()
    // this.initCharts('.level', this.level_option) // 第一个
    this.initCharts('.catogray', this.catogray_option) // 第2个
  },
  methods: {
    getPastDates (days) {
      const result = []

      for (let i = days - 1; i >= 0; i--) {
        const currentDate = new Date()
        currentDate.setDate(currentDate.getDate() - i)
        const year = currentDate.getFullYear()
        const month = String(currentDate.getMonth() + 1).padStart(2, '0')
        const day = String(currentDate.getDate()).padStart(2, '0')
        const formattedDate = `${year}-${month}-${day}`
        result.push(formattedDate)
      }

      return result
    },
    initCharts (eleClass, data) {
      const ele = document.querySelector(eleClass)
      // eslint-disable-next-line no-unused-expressions
      ele !== null ? ele.removeAttribute('_echarts_instance_') : ''
      let myEcharts = null
      let flag = false
      // 初始化 echarts 实例
      if (flag === false) {
        myEcharts = echarts.init(ele)
        flag = true
      }
      // 渲染图表
      myEcharts.setOption(data)
    },
    toggleData () {
      // 去除所有选中样式
      const btnList = document.querySelectorAll('.lines_tabBar .item')
      for (const item of btnList) {
        item.classList.remove('active')
      }
      btnList[0].classList.add('active')

      this.lines_option_month.xAxis.data = this.dataArrayWeek.map((item) => item.startTime)
      this.lines_option_month.series[0].data = this.dataArrayWeek.map((item) => item.repairRate)
      this.initCharts('.lines_content', this.lines_option_month)
    },
    toggleData1 () {
      // 去除所有选中样式
      const btnList = document.querySelectorAll('.lines_tabBar .item')
      for (const item of btnList) {
        item.classList.remove('active')
      }

      btnList[1].classList.add('active')

      this.lines_option_month.xAxis.data = this.dataArrayMonth.map((item) => item.startTime)
      this.lines_option_month.series[0].data = this.dataArrayMonth.map((item) => item.repairRate)
      this.initCharts('.lines_content', this.lines_option_month)
    },
    async getPageData () {
      try {
        const [patchStatData, typeCountData, agentNumData] = await Promise.all([
          getPatchStat({ sourceCode: 'fbylmf' }),
          getTypeCount({ sourceCode: 'fbylmf' }),
          getAgentNum({ sourceCode: 'fbylmf' })
        ])
        const {
          repairedNum,
          unRepairedNum,
          totalNum,
          avgRepairedRate
        } = patchStatData.data

        const {
          patchDangerCount,
          patchHighCount,
          patchMidCount,
          patchLowCount
        } = typeCountData.data

        const { agentServer, totalServer } = agentNumData.data

        // Update component data
        this.card[0].value = repairedNum
        this.card[1].value = unRepairedNum
        this.card[2].value = totalNum
        this.card[3].value = avgRepairedRate.replace(/%/g, '') // Remove percentage

        this.level_option.series.data[0].value = patchDangerCount || 10
        this.level_option.series.data[1].value = patchHighCount || 20
        this.level_option.series.data[2].value = patchMidCount || 20
        this.level_option.series.data[3].value = patchLowCount || 20

        this.initCharts('.level', this.level_option)

        this.total_option.series.data[0].value = agentServer || 10
        this.total_option.series.data[1].value = totalServer || 20

        this.initCharts('.total', this.total_option)
      } catch (error) {
        console.error('Error fetching data:', error)
      }
    },

    // 获取安全狗-周和月漏洞修复走势
    async getMR () {
      this.loading = true
      try {
        const dates = this.getPastDates(30)
        const promises = dates.map(date => {
          return getHistory({
            sourceCode: 'fbylmf',
            date: date
          })
        })
        const results = await Promise.all(promises)

        this.dataArrayMonth = results.map(item => item.data)
        this.loading = false
        // 获取安全狗-周漏洞修复走势
        this.dataArrayWeek = this.dataArrayMonth.slice(-7)
        this.toggleData1()
      } catch (e) {
        console.log(e)
      } finally {
        // this.loading = false
      }
    }

  }
}
</script>

<style lang='less' scoped>
@media screen and (min-width: 128px) {
  .wrapper {
    width: 82vw;

    background: rgba(255, 255, 255, 1);
    border: 1px solid;
    border-image: linear-gradient(180deg, rgba(255, 255, 255, 1), rgba(255, 255, 255, 1)) 1 1;
    padding: 28px 37px 68px 37px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    overflow: scroll;

    .wrapper_top {
      height: 35px;
      width: 100%;
      display: flex;
      justify-content: flex-start;
      align-items: center;
    }

    .wrapper_title {
      height: 35px;
      font-size: 23px;
      font-family: PingFangSC-Semibold, PingFang SC;
      font-weight: 600;
      color: #000000;
      height: 35px;
      display: flex;
    }

    // .back {
    //   width: 31px;
    //   height: 31px;
    //   background: url('@/assets/images/security/icon_exit.png') no-repeat center;
    //   background-size: cover;
    //   margin-left: auto;
    // }

    .content {
      margin-top: 14px;
      flex: 1;
      display: flex;
      flex-direction: column;

      // card
      .content_card {
        height: 92px;
        display: flex;
        justify-content: space-between;

        .card_wrapper {
          width: 270px;
          height: 92px;
          box-sizing: border-box;
          padding: 15px 0 0 34px;
          margin-right: 42px;

          background: linear-gradient(135deg, #19d98b 0%, #138182 100%);
          border-radius: 8px;

          &:nth-last-child(1) {
            margin-right: 0;
          }

          display: flex;

          .icon {
            width: 62.91px;
            height: 76.67px;
            margin-right: 26px;
          }

          .c_content {
            display: flex;
            flex-direction: column;
            margin-top: 3.5px;

            .titleText {
              height: 13px;
              font-size: 12px;
              font-family: MicrosoftYaHei;
              color: #ffffff;
              line-height: 13px;
              margin-bottom: 17px;
              text-align: center;
            }

            .countNum {
              display: flex;
              align-items: flex-end;

              // ------------------------------------------------------------------------
              .value {
                height: 25px;
                font-size: 25px;
                font-family: PingFangSC-Semibold, PingFang SC;
                font-weight: 600;
                color: #ffffff;
                line-height: 25px;
                margin-right: 7.8px;
                display: flex;
              }

              .unit {
                width: 12px;
                height: 12px;
                font-size: 12px;
                font-family: MicrosoftYaHei;
                color: #ffffff;
                line-height: 7px;
                margin-bottom: 5px;
              }
            }
          }
        }
      }

      // pie
      .content_pie_wrapper {
        width: 100%;
        height: 304px;
        // margin: 40px 0 20px 0;
        display: flex;

        .pie {
          flex: 1 1 33.33%;
          height: 100%;
        }
      }

      // lines
      .content_lines_wrapper {

        display: flex;
        height: 289px;
        flex-direction: column;
        margin-top: 20px;
        .lines_title {
          height: 24px;
          display: flex;

          .titleTextTwo {
            width: 150px;
            height: 18px;
            font-size: 18px;
            font-family: PingFangSC-Semibold, PingFang SC;
            font-weight: 600;
            color: rgba(0, 96, 163, 1);
            line-height: 18px;
            margin-right: 31px;
            margin-top: 3px;
          }

          .lines_tips {
            position: relative;
            width: 60px;
            height: 18px;
            font-size: 15px;
            font-family: PingFangSC-Regular, PingFang SC;
            font-weight: 400;
            color: rgba(0, 0, 0, 0.7);
            line-height: 18px;
            margin-left: 53rem;
            margin-top: 3px;

            &::before {
              content: '';
              display: block;
              position: absolute;
              width: 13px;
              height: 13px;
              border-radius: 50%;
              background: #0b99ff;
              top: 2.5px;

              margin: auto;
              left: -18.5px;
            }
          }

          .lines_tabBar {
            margin-left: 4rem;
            display: flex;

            .item {
              position: relative;
              width: 88px;
              height: 24px;
              text-align: center;
              line-height: 24px;
              font-size: 16px;
              font-family: PingFangSC-Regular, PingFang SC;
              color: rgba(0, 150, 255, 1);
              border: 1px solid rgba(0, 150, 255, 1);

              &:nth-child(1) {
                margin-right: 14px;
              }

              // 扩大按钮点击范围
              &::after {
                content: '';
                position: absolute;
                left: -5px;
                right: -5px;
                top: -5px;
                bottom: -5px;
              }
            }

            .active {
              background: rgba(0, 150, 255, 1);
              color: #0e263e;
            }
          }
        }

        .lines_content {
          height: 300px;
          position: relative;
          top: 2px;
          right: 7.5px;
          flex: 1;
          width: 100%;
        }
      }

      .tips_lines {
        display: none;
        height: 16px;
        background: #153e68;
        border: 1px solid #3b6f9f;
        margin-top: 7.62px;
      }
    }
  }
}

.bottonbox {
  width: 1153px;
  height: 28px;
  // max-height:28px ;
  background: #153E68;
  border: 1px solid #3B6F9F;
  margin-left: 25.7px;
  position: relative;
  // flex: 1;
  display: flex;
  align-items: center; // 垂直居中对齐内容
  &::before {
    content: "";
    position: absolute;
    width: 0.6%;
    height: 53.6%;
    background-color: #64B2FF;
    left: 0%;
    transform: translateX(-50%);
  }

  &::after {
    content: "";
    position: absolute;
    width: 0.6%;
    height: 53.6%;
    background-color: #64B2FF;
    right: 0%;
    transform: translateX(50%);
  }
}
</style>

<template>
  <div class="wrapper">
    <!-- flex布局 -->
    <!-- 内容主体 -->
    <a-select v-model="selectedOrganize" style="width: 200px" @change="onChange">
      <a-select-option v-for="item in organizeList" :key="item.organizeId" :value="item.organizeId">
        {{ item.organizeName }}
      </a-select-option>
    </a-select>
    <div class="content">
      <!-- card -->
      <div class="content_card">
        <div class="card_wrapper" v-for="item in card" :key="item.id" :style="item.style">
          <div
            class="icon"
            :style="{
              background: 'url(' + item.img +') no-repeat',
              backgroundSize: 'cover',
            }"></div>
          <div class="c_content">
            <div class="titleText">
              {{ item.title }}
            </div>
            <div class="countNum">
              <a-spin :spinning="loading1">
                <div class="value">
                  {{ item.value }}
                </div>
              </a-spin>
              <div class="unit">
                {{ item.unit }}
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- card end -->

      <!-- echarts pie -->
      <div class="content_pie_wrapper">
        <a-spin :spinning="loading1" style="height: 304px;width: 100%"><div class="pie level"></div></a-spin>
        <a-spin :spinning="loading2" style="height: 304px;width: 100%"><div class="pie catogray"></div></a-spin>
        <a-spin :spinning="loading3" style="height: 304px;width: 100%"><div class="pie total"></div></a-spin>
      </div>
      <!-- echarts pie end -->

      <a-spin :spinning="loading">
        <div class="content_lines_wrapper">
          <div class="lines_title">
            <div class="titleTextTwo">漏洞修复走势</div>
            <div class="lines_tips">修复率</div>
            <div class="lines_tabBar">
              <div class="item" @click="toggleData">本周</div>
              <div class="item active" @click="toggleData1">本月</div>
            </div>
          </div>
          <div class="lines_content"></div>

        </div>
      </a-spin>
      <!-- <div class="bottonbox"></div> -->
      <!-- end -->
      <div class="tips_lines"></div>
    </div>
    <div class="bottonBar">
    </div>
  </div>
</template>

<script>
import {
  card,
  level_option,
  catogray_option,
  total_option,
  lines_option_month,
  getPatchType,
  getPatchStat,
  getHistory,
  getTypeCount,
  getAgentNum
} from './api.js'
import * as echarts from 'echarts'
import { axios } from '@/utils/request'

export default {
  name: 'VulnerabilityMonitoring',
  data () {
    return {
      card,
      total_option,
      lines_option_month,
      level_option,
      catogray_option,
      dataArrayWeek: null,
      dataArrayMonth: null,
      loading: false,
      loading1: false,
      loading2: false,
      loading3: false,
      loading4: false,
      sourceCode: '',
      selectedOrganize: null,
      organizeList: null
    }
  },
  // components: {
  //   Tabbar,
  // },

  mounted () {
    // 获取分权分域的sourceCode
    this.get_sourceCode()
    // this.initCharts('.level', this.level_option) // 第一个
    // this.initCharts('.catogray', this.catogray_option) // 第2个
  },
  methods: {
    async get_sourceCode () {
      // try {
      // const data = { data: [
      //   {
      //     organizeId: '77551230678728704',
      //     sourceCode: 'fbylmf',
      //     organizeName: '北京数据中心',
      //     parentId: '77550822937853952'
      //   }] }
      await axios.get('/cloudNet/get').then(data => {
        console.log(data)
        if (data.code === 200 && data.data.length > 0) {
          this.selectValue = data.data
          this.organizeList = data.data
          this.sourceCode = data.data[0].sourceCode
          this.selectedOrganize = data.data[0].organizeId
          this.getPageData()
        } else {
          this.congzhi()
          this.$notification.error({
            message: '系统提示',
            // description: data.data.description
            description: '暂无数据'
          })
        }
      })

      // 获取安全狗-月漏洞修复走势
      this.getMR()
      // } catch (e) {
      //   this.$notifyError(e)
      //   throw e
      // }
    },
    onChange (value) {
      const item = this.organizeList.filter(el => el.organizeId === value)
      // console.log(item[0].sourceCode)
      this.sourceCode = item[0].sourceCode
      this.getPageData()
      this.getMR()
    },
    initCharts (eleClass, data) {
      const ele = document.querySelector(eleClass)
      // eslint-disable-next-line no-unused-expressions
      ele !== null ? ele.removeAttribute('_echarts_instance_') : ''

      let myEcharts = null

      myEcharts = echarts.init(ele)

      myEcharts.setOption(data)
    },
    toggleData () {
      // 去除所有选中样式
      const btnList = document.querySelectorAll('.lines_tabBar .item')
      for (const item of btnList) {
        item.classList.remove('active')
      }
      btnList[0].classList.add('active')

      if (this.dataArrayWeek.length > 0) {
        this.lines_option_month.xAxis.data = this.dataArrayWeek.map((item) => item.startTime)
        this.lines_option_month.series[0].data = this.dataArrayWeek.map((item) => item.repairRate)
        this.lines_option_month.yAxis.axisLine.show = true
        this.lines_option_month.graphic.invisible = true
      } else {
        this.lines_option_month.xAxis.data = undefined
        this.lines_option_month.series[0].data = undefined
        this.lines_option_month.graphic.invisible = false
        this.lines_option_month.yAxis.axisLine.show = false
      }
      this.initCharts('.lines_content', this.lines_option_month)
    },
    toggleData1 () {
      // 去除所有选中样式
      const btnList = document.querySelectorAll('.lines_tabBar .item')
      for (const item of btnList) {
        item.classList.remove('active')
      }

      btnList[1].classList.add('active')
      if (this.dataArrayMonth.length > 0) {
        this.lines_option_month.xAxis.data = this.dataArrayMonth.map((item) => item.startTime)
        this.lines_option_month.series[0].data = this.dataArrayMonth.map((item) => item.repairRate)
        this.lines_option_month.yAxis.axisLine.show = true
        this.lines_option_month.graphic.invisible = true
      } else {
        // 暂无数据
        this.lines_option_month.xAxis.data = undefined
        this.lines_option_month.series[0].data = undefined
        this.lines_option_month.yAxis.axisLine.show = false
        this.lines_option_month.graphic.invisible = false
      }
      this.initCharts('.lines_content', this.lines_option_month)
    },
    async getPageData () {
      this.loading1 = true
      this.loading2 = true
      this.loading3 = true
      this.loading4 = true
      try {
        const [patchStatData, typeCountData, agentNumData, getPatchTypeData] = await Promise.all([
          getPatchStat({ sourceCode: this.sourceCode }),
          getTypeCount({ sourceCode: this.sourceCode }),
          getAgentNum({ sourceCode: this.sourceCode }),
          getPatchType({ sourceCode: this.sourceCode })
        ])
        const {
          repairedNum,
          unRepairedNum,
          totalNum,
          avgRepairedRate
        } = patchStatData.data

        const {
          patchDangerCount,
          patchHighCount,
          patchMidCount,
          patchLowCount
        } = typeCountData.data

        const { agentServer, totalServer } = agentNumData.data
        const getPatchTypeData_echarts = getPatchTypeData.data

        /* const getPatchTypeData_echarts = {
          '代码注入': 33,
          '输入验证错误': 46,
          '其他': 201,
          '代码问题': 459,
          '远程代码执行': 901
        } */
        const getPatchTypeKeys = Object.keys(getPatchTypeData_echarts)
        const getPatchTypeKValue = Object.values(getPatchTypeData_echarts)

        this.catogray_option.legend.data = getPatchTypeKeys

        this.catogray_option.series.data.forEach((item, index) => {
          item.value = getPatchTypeKValue[index]
          item.name = getPatchTypeKeys[index]
        })

        // 全网已修复4个
        this.card[0].value = repairedNum
        this.card[1].value = unRepairedNum
        this.card[2].value = totalNum
        this.card[3].value = avgRepairedRate.replace(/%/g, '') // Remove percentage
        this.loading4 = false

        this.level_option.series.data[0].value = patchDangerCount || 10
        this.level_option.series.data[1].value = patchHighCount || 20
        this.level_option.series.data[2].value = patchMidCount || 20
        this.level_option.series.data[3].value = patchLowCount || 20

        this.total_option.series.data[0].value = agentServer || 10
        this.total_option.series.data[1].value = totalServer || 20
        // 打开legend
        this.level_option.legend.show = true
        this.total_option.legend.show = true
        // 去除暂无数据
        this.total_option.graphic.invisible = true
        this.catogray_option.graphic.invisible = true
        this.level_option.graphic.invisible = true

        this.initCharts('.catogray', this.catogray_option) // 漏洞类型占比
        this.initCharts('.level', this.level_option)
        this.initCharts('.total', this.total_option)
        this.loading1 = false
        this.loading2 = false
        this.loading3 = false
      } catch (error) {
        console.error('Error fetching data:', error)
        console.log(catogray_option)
        this.congzhi()
        this.loading1 = false
        this.loading2 = false
        this.loading3 = false
        this.loading4 = false
      }
    },
    // 重置echarts
    congzhi () {
      this.card[0].value = '--'
      this.card[1].value = '--'
      this.card[2].value = '--'
      this.card[3].value = '--'

      this.total_option.graphic.invisible = false
      this.catogray_option.graphic.invisible = false
      this.level_option.graphic.invisible = false
      this.level_option.legend.show = false
      this.total_option.legend.show = false

      this.level_option.series.data[0].value = null
      this.level_option.series.data[1].value = null
      this.level_option.series.data[2].value = null
      this.level_option.series.data[3].value = null

      this.total_option.series.data[0].value = null
      this.total_option.series.data[1].value = null

      this.catogray_option.series.data.forEach((item, index) => {
        item.value = null
        item.name = null
      })
      this.initCharts('.catogray', this.catogray_option) // 漏洞类型占比
      this.initCharts('.level', this.level_option)
      this.initCharts('.total', this.total_option)
    },
    // 获取安全狗-周和月漏洞修复走势
    async getMR () {
      this.loading = true
      try {
        // const dates = this.getPastDates(30)
        // const promises = dates.map(date => {
        //   return getHistory({
        //     sourceCode: this.sourceCode,
        //     date: date
        //   })
        // })
        // const pastDates = getHistory({
        //   sourceCode: this.sourceCode,
        //   date: 30
        // })
        // const results = await Promise.all(promises)
        //
        // this.dataArrayMonth = results.map(item => item.data)
        const results = await getHistory({
          sourceCode: this.sourceCode,
          day: 30
        })

        this.dataArrayMonth = results.data
        this.loading = false
        // 获取安全狗-周漏洞修复走势
        this.dataArrayWeek = this.dataArrayMonth.slice(-7)
        this.toggleData1()
      } catch (e) {
        console.log(e)
        this.dataArrayMonth = []
        this.dataArrayWeek = this.dataArrayMonth.slice(-7)
        this.toggleData1()
      } finally {
        this.loading = false
      }
    }

  }
}
</script>

<style lang='less' scoped>
@media screen and (min-width: 128px) {
  .wrapper {
    width: 82vw;

    background: rgba(255, 255, 255, 1);
    border: 1px solid;
    border-image: linear-gradient(180deg, rgba(255, 255, 255, 1), rgba(255, 255, 255, 1)) 1 1;
    padding: 28px 37px 68px 37px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    overflow: scroll;

    .wrapper_top {
      height: 35px;
      width: 100%;
      display: flex;
      justify-content: flex-start;
      align-items: center;
    }

    .wrapper_title {
      height: 35px;
      font-size: 23px;
      font-family: PingFangSC-Semibold, PingFang SC;
      font-weight: 600;
      color: #000000;
      height: 35px;
      display: flex;
    }

    // .back {
    //   width: 31px;
    //   height: 31px;
    //   background: url('@/assets/images/security/icon_exit.png') no-repeat center;
    //   background-size: cover;
    //   margin-left: auto;
    // }

    .content {
      margin-top: 14px;
      flex: 1;
      display: flex;
      flex-direction: column;

      // card
      .content_card {
        height: 92px;
        display: flex;
        justify-content: space-between;

        .card_wrapper {
          width: 270px;
          height: 92px;
          box-sizing: border-box;
          padding: 15px 0 0 34px;
          margin-right: 42px;

          background: linear-gradient(135deg, #19d98b 0%, #138182 100%);
          border-radius: 8px;

          &:nth-last-child(1) {
            margin-right: 0;
          }

          display: flex;

          .icon {
            width: 62.91px;
            height: 76.67px;
            margin-right: 26px;
          }

          .c_content {
            display: flex;
            flex-direction: column;
            margin-top: 3.5px;

            .titleText {
              height: 13px;
              font-size: 12px;
              font-family: MicrosoftYaHei;
              color: #ffffff;
              line-height: 13px;
              margin-bottom: 17px;
              text-align: center;
            }

            .countNum {
              display: flex;
              align-items: flex-end;

              // ------------------------------------------------------------------------
              .value {
                height: 25px;
                font-size: 25px;
                font-family: PingFangSC-Semibold, PingFang SC;
                font-weight: 600;
                color: #ffffff;
                line-height: 25px;
                margin-right: 7.8px;
                display: flex;
              }

              .unit {
                width: 12px;
                height: 12px;
                font-size: 12px;
                font-family: MicrosoftYaHei;
                color: #ffffff;
                line-height: 7px;
                margin-bottom: 5px;
              }
            }
          }
        }
      }

      // pie
      .content_pie_wrapper {
        width: 100%;
        height: 304px;
        // margin: 40px 0 20px 0;
        display: flex;

        .pie {
          flex: 1 1 33.33%;
          height: 304px;
        }
      }

      // lines
      .content_lines_wrapper {

        display: flex;
        height: 289px;
        flex-direction: column;
        margin-top: 20px;
        .lines_title {
          height: 24px;
          display: flex;

          .titleTextTwo {
            width: 150px;
            height: 18px;
            font-size: 18px;
            font-family: PingFangSC-Semibold, PingFang SC;
            font-weight: 600;
            color: rgba(0, 96, 163, 1);
            line-height: 18px;
            margin-right: 31px;
            margin-top: 3px;
          }

          .lines_tips {
            position: relative;
            width: 60px;
            height: 18px;
            font-size: 15px;
            font-family: PingFangSC-Regular, PingFang SC;
            font-weight: 400;
            color: rgba(0, 0, 0, 0.7);
            line-height: 18px;
            margin-left: 53rem;
            margin-top: 3px;

            &::before {
              content: '';
              display: block;
              position: absolute;
              width: 13px;
              height: 13px;
              border-radius: 50%;
              background: #0b99ff;
              top: 2.5px;

              margin: auto;
              left: -18.5px;
            }
          }

          .lines_tabBar {
            margin-left: 4rem;
            display: flex;

            .item {
              position: relative;
              width: 88px;
              height: 24px;
              text-align: center;
              line-height: 24px;
              font-size: 16px;
              font-family: PingFangSC-Regular, PingFang SC;
              color: rgba(0, 150, 255, 1);
              border: 1px solid rgba(0, 150, 255, 1);

              &:nth-child(1) {
                margin-right: 14px;
              }

              // 扩大按钮点击范围
              &::after {
                content: '';
                position: absolute;
                left: -5px;
                right: -5px;
                top: -5px;
                bottom: -5px;
              }
            }

            .active {
              background: rgba(0, 150, 255, 1);
              color: #fff !important;
            }
          }
        }

        .lines_content {
          height: 300px;
          position: relative;
          top: 2px;
          right: 7.5px;
          flex: 1;
          width: 100%;
        }
      }

      .tips_lines {
        display: none;
        height: 16px;
        background: #153e68;
        border: 1px solid #3b6f9f;
        margin-top: 7.62px;
      }
    }
  }
}

.bottonbox {
  width: 1153px;
  height: 28px;
  // max-height:28px ;
  background: #153E68;
  border: 1px solid #3B6F9F;
  margin-left: 25.7px;
  position: relative;
  // flex: 1;
  display: flex;
  align-items: center; // 垂直居中对齐内容
  &::before {
    content: "";
    position: absolute;
    width: 0.6%;
    height: 53.6%;
    background-color: #64B2FF;
    left: 0%;
    transform: translateX(-50%);
  }

  &::after {
    content: "";
    position: absolute;
    width: 0.6%;
    height: 53.6%;
    background-color: #64B2FF;
    right: 0%;
    transform: translateX(50%);
  }
}
</style>
